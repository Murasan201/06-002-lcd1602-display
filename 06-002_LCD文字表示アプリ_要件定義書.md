### 文書番号: 06-002

## 1. アプリ名
- アプリ名: LCD文字表示アプリ

## 2. 概要
LCD1602モジュール（I²CバックパックまたはSPIインターフェース付き）を用いて、Raspberry Piから任意の文字列を表示するPythonアプリケーションです。本アプリを通じて、I²C/SPI通信の基礎とLCD1602制御方法を学ぶハンズオン教材として活用します。

## 3. 目的
- I²C/SPI通信プロトコルの基本理解
- LCD1602モジュール制御の習得
- Pythonによる外部周辺機器制御技術の習得

## 4. 対象利用者
- プログラミング初心者
- Raspberry Pi入門者
- 電子工作学習者

## 5. システム構成
| コンポーネント                      | 型番・仕様                                              | 役割                                                    |
|-------------------------------------|--------------------------------------------------------|---------------------------------------------------------|
| Raspberry Pi 5                      | Raspberry Pi 5                                         | I²C通信制御、スクリプト実行                            |
| ブレッドボード                      | 汎用ブレッドボード                                      | 各モジュールの固定および配線                            |
| ジャンパーワイヤ                    | オス–オス                                              | Raspberry Piと各モジュールの接続                       |
| LCD1602ディスプレイモジュール       | HD44780互換 + PCF8574T I²Cバックパック                 | 文字表示（16文字×2行）、I²C通信                        |
| 双方向ロジックレベル変換モジュール   | BSS138搭載 4チャンネル（3.3V⇔5V）                    | Raspberry Pi（3.3V）とLCD（5V）間の電圧レベル変換      |

## 6. ハードウェア要件

### 6.1 必須コンポーネント
- **Raspberry Pi 5本体**
- **microSDカード**（Raspberry Pi OSインストール済み）
- **LCD1602ディスプレイモジュール**
  - HD44780互換LCDコントローラ
  - PCF8574T I²Cバックパック搭載
  - デフォルトI²Cアドレス: 0x27（PCF8574T）または0x3F（PCF8574AT）
  - 内蔵コントラスト調整用可変抵抗器
- **双方向ロジックレベル変換モジュール**
  - BSS138 MOSFET搭載 4チャンネル
  - 対応電圧: 低電圧側 1.8V～ / 高電圧側 ～10V（本プロジェクトでは3.3V⇔5V変換）
  - I²C通信対応（最大2MHz）
  - 製品例: VKLSVAN 4チャンネル双方向ロジックレベル変換モジュール
- **ジャンパーワイヤ**（オス–オス、10本程度）
- **ブレッドボード**（汎用サイズ）
- **電源**（公式5V/3A電源アダプタ推奨）

### 6.2 各デバイスの技術仕様

#### 6.2.1 PCF8574T I²C I/Oエクスパンダ
- **動作電圧範囲**: 2.5V～6V
- **I²Cインターフェース**: 標準モード 100kHz
- **I/Oポート数**: 8ビット双方向
- **ESD保護**: HBM 2,000V以上、CDM 1,000V以上
- **LCD接続ピン配置**:
  - P0: RS（レジスタ選択）
  - P1: RW（読み書き制御）
  - P2: E（イネーブル）
  - P3: バックライト制御
  - P4-P7: D4-D7（データ線）

#### 6.2.2 BSS138 双方向ロジックレベル変換モジュール
- **使用FET**: BSS138 x 4個
- **プルアップ抵抗**: 10kΩ（各チャンネル）
- **チャンネル数**: 4チャンネル独立双方向変換
- **低電圧側対応**: 1.8V～
- **高電圧側対応**: ～10V
- **オン抵抗**: 3.5Ω（BSS138）
- **入力容量**: 40pF
- **連続電流**: 200mA
- **ピーク電流**: 1A（最大しきい値電圧時）
- **対応プロトコル**: I²C、TTL Serial、低速SPI（<2MHz）、その他デジタルインターフェース

#### 6.2.3 配線構成
**Raspberry Pi 5 (3.3V側) ⇔ レベル変換モジュール ⇔ LCD1602 + PCF8574T (5V側)**

| Raspberry Pi 5 | レベル変換（LV側）| レベル変換（HV側）| PCF8574T/LCD |
|----------------|------------------|------------------|--------------|
| 3.3V (Pin 1)   | LV               | -                | -            |
| 5V (Pin 2)     | -                | HV               | VCC          |
| GND (Pin 6)    | GND              | GND              | GND          |
| SDA (Pin 3)    | LV1              | HV1              | SDA          |
| SCL (Pin 5)    | LV2              | HV2              | SCL          |

## 7. ソフトウェア要件
- **OS**: Raspberry Pi OS（最新推奨）
- **言語**: Python 3.9以上
- **必須ライブラリ**:
  - **RPLCD** (>=1.3.0): LCD1602制御、PCF8574対応
  - **smbus2** (>=0.4.0): I²C通信
  - **argparse**: コマンドライン引数処理（Python標準ライブラリ）
- **I²C有効化**: `sudo raspi-config`でI²Cインターフェースを有効化
- **I²C確認ツール**: `i2c-tools`パッケージ（`i2cdetect`コマンド使用）

## 8. 機能要件
1. **I²C通信初期化**
   - RPLCDライブラリを使用してPCF8574T経由でLCD1602モジュールを初期化
   - I²Cアドレス指定（デフォルト: 0x27、オプションで変更可能）
   - I²Cポート指定（デフォルト: 1）
   - 文字マップ選択（'A02'または'A00'）
   - バックライト自動有効化
2. **文字列表示**
   - コマンドライン引数で指定した文字列をLCD1602の指定行に表示
   - 16文字以内は通常表示、16文字超過時はスクロール表示（オプション）
3. **行指定表示**
   - 第1行／第2行（16文字×2行）を選択して表示
   - 行指定なしの場合はデフォルトで第1行に表示
4. **スクロール表示**
   - 文字列が16文字を超える場合、指定間隔（デフォルト0.3秒）で横スクロール表示
   - `--scroll`オプションで明示的に有効化
5. **コントラスト調整**
   - PCF8574Tバックパック基板上の可変抵抗器で手動調整
   - ソフトウェアでの調整は不要（ハードウェアで調整）
6. **表示クリア**
   - `--clear`オプションで画面クリアコマンドを実行し、LCD1602表示をリセット

## 9. 非機能要件
- **可読性**:
  - コードはPEP8準拠
  - 日本語コメントで初心者にもわかりやすい説明
  - 関数・クラスごとにdocstring記述
- **保守性**:
  - クラスベースの設計でLCD操作をカプセル化
  - 拡張可能な構造（将来的な機能追加に対応）
- **移植性**:
  - RPLCDライブラリを使用し、他のI²Cエクスパンダにも対応可能
  - 設定値（I²Cアドレス、ポート）をコマンドライン引数で変更可能
- **安全性**:
  - 電圧レベル変換により、Raspberry Pi GPIOピンを5V信号から保護
  - 適切なエラーハンドリング実装
  - I²Cアドレス・引数の検証

## 10. 安全要件
### 10.1 電圧レベル保護
- **必須**: BSS138双方向ロジックレベル変換モジュールを使用
  - Raspberry Pi I²Cピン（3.3V）を5Vプルアップから保護
  - PCF8574Tモジュールは5V駆動でLCDバックライトを明るく点灯
  - I²C信号（SDA/SCL）は3.3V⇔5V間で双方向変換
- **警告**: レベル変換なしで5V I²Cプルアップに直接接続すると、Raspberry Pi GPIOピンが破損する可能性あり

### 10.2 配線時の注意事項
- 電源投入前に配線を確認
- VCCとGNDのショート防止
- ジャンパーワイヤの接続確認

## 11. テスト要件
- **I²C有効化確認**: Raspberry Pi設定でI²Cが有効化されていることを確認
- **I²C通信テスト**: `i2cdetect -y 1`でPCF8574TのI²Cアドレス（0x27または0x3F）検出
- **レベル変換確認**: オシロスコープまたはロジックアナライザでSDA/SCL信号レベルを確認（オプション）
- **文字列長テスト**:
  - 短文（16文字以内）で正常表示確認
  - 長文（16文字超）でスクロール動作確認
- **行指定テスト**: 第1行・第2行への表示切り替え確認
- **文字マップテスト**: charmapパラメータ（A02/A00）で文字化けしないことを確認
- **異常系テスト**:
  - 無効なI²Cアドレス指定時のエラーハンドリング確認
  - 無効な引数入力時の適切なエラーメッセージ表示確認
- **割り込みテスト**: Ctrl+C押下時の適切な終了処理とリソースクリーンアップ確認

## 12. 受け入れ基準
1. **ハードウェア構成**:
   - BSS138レベル変換モジュールを経由してRaspberry PiとPCF8574T搭載LCD1602が正しく接続されている
   - `i2cdetect -y 1`でPCF8574TのI²Cアドレスが検出される
2. **基本表示機能**:
   - 指定文字列がLCD1602の正しい行（第1行または第2行）に表示される
   - 文字マップ設定（A02/A00）により文字化けせず正常表示される
   - バックライトが自動的に点灯する
3. **スクロール機能**:
   - 16文字を超える文字列が横スクロール表示される
   - スクロール間隔が適切（デフォルト0.3秒）
4. **コントラスト調整**:
   - PCF8574Tバックパック基板上の可変抵抗器で文字が見やすく調整できる
5. **画面クリア機能**:
   - `--clear`オプションで表示が完全にリセットされる
6. **エラーハンドリング**:
   - 不正なI²Cアドレス・引数時に適切なエラーメッセージが表示される
   - I²C通信エラー時に明確なエラーメッセージとトラブルシュート情報が表示される
7. **安全性**:
   - 電圧レベル変換により、Raspberry Pi GPIOピンが保護されている
   - Ctrl+C割り込み時に適切な終了処理が実行される

---

## 13. 参考文献・データシート
- [PCF8574 Remote 8-Bit I/O Expander Datasheet (Texas Instruments)](https://www.ti.com/lit/ds/symlink/pcf8574.pdf)
- [BSS138 N-Channel MOSFET Datasheet](https://cdn.sparkfun.com/datasheets/BreakoutBoards/BSS138.pdf)
- [HD44780 LCD Controller Datasheet](https://www.sparkfun.com/datasheets/LCD/HD44780.pdf)
- [RPLCD Documentation](https://rplcd.readthedocs.io/)
- [NXP I2C Level Shifting Techniques (Application Note AN10441)](https://www.nxp.com/docs/en/application-note/AN10441.pdf)

---
以上の要件をもとに、LCD文字表示アプリを開発してください。

**最終更新**: 2025年10月21日
**文書番号**: 06-002
**バージョン**: 2.0
